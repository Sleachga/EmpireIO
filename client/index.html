<!--
  ______                    _              _____  ____
 |  ____|                  (_)            |_   _|/ __ \
 | |__    _ __ ___   _ __   _  _ __  ___    | | | |  | |
 |  __|  | '_ ` _ \ | '_ \ | || '__|/ _ \   | | | |  | |
 | |____ | | | | | || |_) || || |  |  __/  _| |_| |__| |
 |______||_| |_| |_|| .__/ |_||_|   \___| |_____|\____/
                    | |
                    |_|
       |\   ,____
       |\   \/   `.
       \ `-.:.     `\
        `-.__ `\=====|
           /=`'/   ^_\
         .'   /\   .=)
      .-'  .'|  '-(/_|
    .'  __(  \  .'`
   /_.'`  `.  |`
            \ |
             |/
TODO:

Canvas onLeftClick highlights a region and commands
all units in that area.  Add a goto point function

Canvas onRightClick makes a menu similar to paragon,
highlights the button its over and gives you the
option to create units

Add mini map, maybe make it a popup menu when you
hold down q

https://www.kirupa.com/html5/getting_mouse_click_position.htm

When you move multiple units to one spot put them randomly in a circle
with a certain radius around the point clicked

EX:

             point ~~~>     *

                           ___
                         /     \
    finishing area ~~~>  |  *  |
                         \_____/
-->

<html>
<head>
    <title>Empire IO</title>
    <link rel="icon" href="/client/img/favicon.ico"/>
    <link rel="stylesheet" href="/client/index.css"/>
</head>

<body>

<div id="canvasContainer">
    <canvas id="ctx" width="500" height="500"></canvas>
</div>

<br>

<button id="mapRandButton">Randomize Map</button>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="/client/img/images.js"></script>


<script>
    var DEBUG = false;

    // Prevents going back or forward a page by two finger swipe
    document.body.addEventListener('wheel', function (e)
    {
        e.preventDefault();
    });

    // Creates an object for the canvas
    var ctx = document.getElementById("ctx").getContext("2d");

    ctx.canvas.width = window.innerWidth - 20;
    ctx.canvas.height = window.innerHeight - 20;
    ctx.font = '30px Arial';

    var mouseX = 0; // X coordinate of mouse
    var mouseY = 0; // Y coordinate of mouse
    var mouseDown = false;
    var mouseClickPos = // Position of last mouseclick
        {
            x: 0,
            y: 0
        };

    var clickOffsetX = 0; // Amount camera has moved horizontally since click
    var clickOffsetY = 0; // Amount camera has moved vertically since click

    var unitList; // Object containing all units

    var WIDTH = window.innerWidth; // Width of browser window at gameload
    var HEIGHT = window.innerHeight; // Height of browser window at gameload
    var screenX = 0; // horizontal position of the screen in the game
    var screenY = 0; // vertical position of the screen in the game
    var cameraSpeed = 3; // Speed per pixels camera moves
    var keys = // Object to keep track of which keys are pressed
        {
            up: false,
            down: false,
            left: false,
            right: false
        };

    var minimap = // Object to draw minimap (in-progress)
        {
            width: WIDTH / 5,
            height: HEIGHT / 5,
            x: ((WIDTH / 5) * 4),
            y: ((HEIGHT / 5) * 4)
        };

    var drawMiniMap = function () // function to draw minimap (in-progress)
    {
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = "black";
        ctx.fillRect(minimap.x, minimap.y, minimap.height, minimap.height);
        ctx.globalAlpha = 1;
    };

    document.onkeydown = function (event) // Movement key down listener
    {
        if (event.keyCode === 68 || event.keyCode === 39) //d or right
            keys.right = true;
        else if (event.keyCode === 65 || event.keyCode === 37) //a or left
            keys.left = true;
        else if (event.keyCode === 83 || event.keyCode === 40) //s or down
            keys.down = true;
        else if (event.keyCode === 87 || event.keyCode === 38) //w or up
            keys.up = true;
    };

    document.onkeyup = function (event) // Movement key up listener
    {
        if (event.keyCode === 68 || event.keyCode === 39) //d or right
            keys.right = false;
        else if (event.keyCode === 65 || event.keyCode === 37) //a or left
            keys.left = false;
        else if (event.keyCode === 83 || event.keyCode === 40) //s or down
            keys.down = false;
        else if (event.keyCode === 87 || event.keyCode === 38) //w or up
            keys.up = false;
    };

    document.onmousemove = function (event) // Mouse move listener
    {
        // Set global mouseX and mouseY variables
        mouseX = event.clientX;
        mouseY = event.clientY;
    };

    // Keeps the right click from popping a menu up
    document.oncontextmenu = function (event)
    {
        var evt = new Object({keyCode: 93});

        if (event.preventDefault !== undefined)
            event.preventDefault();

        if (event.stopPropagation !== undefined)
            event.stopPropagation();
    };

    document.onmousedown = function (event) // Mouse click down listener
    {
        var button = event.button;

        if (button === 2)
            if (DEBUG) console.log("Right Mouse Click");
        else if (button === 0)
            if (DEBUG) console.log("Left Mouse Click");

        mouseDown = true;
        mouseClickPos.x = event.clientX;
        mouseClickPos.y = event.clientY;

        if (DEBUG) console.log("Click -> X: " + mouseClickPos.x
            + " Y: " + mouseClickPos.y);
    };

    document.onmouseup = function (event) // Mouse click up listener
    {
        mouseDown = false;
        clickOffsetX = 0;
        clickOffsetY = 0;
    };

    // Creates an object for the randomize map button
    var mapRand = document.getElementById('mapRandButton');

    // Calls a function to reset the map grid on button click
    mapRand.onclick = function ()
    {
        socket.emit('mapRand');
    };

    // Creates the socket.io object
    var socket = io();

    // TODO Declare this without actually having to type it out

    // Creates and sets the default for the map matrix
    var mapMatrix = [
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], // 1
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], // 2
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], // 3
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], // 4
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], // 5
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], // 6
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], // 7
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], // 8
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], // 9
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]  // 10
    ];

    // Initially sets the map grid
    socket.on('mapInit', function (data)
    {
        var mapGrid = data;

        // Convert into 2d array
        var counter = 0;

        for (var i = 0; i < 10; i++)
        {
            for (var j = 0; j < 10; j++)
            {
                if (DEBUG) console.log(mapGrid[counter]);
                mapMatrix[i][j] = mapGrid[counter++];
            }
        }
    });

    // Sets the map grid on update (25 times a second)
    socket.on('update', function (data)
    {
        unitList = data;
    });

    /*
      Essentially the main loop, game logic and canvas drawing
      Goes on here
    */
    setInterval(function ()
    {
        if (keys.right)
        {
            screenX -= cameraSpeed; // Move camera right
            if (mouseDown) clickOffsetX += cameraSpeed;
        }
        if (keys.left)
        {
            screenX += cameraSpeed; // Move camera left
            if (mouseDown) clickOffsetX -= cameraSpeed;
        }
        if (keys.up)
        {
            screenY += cameraSpeed; // Move camera up
            if (mouseDown) clickOffsetY -= cameraSpeed;
        }
        if (keys.down)
        {
            screenY -= cameraSpeed; // Move camera down
            if (mouseDown) clickOffsetY += cameraSpeed;
        }

        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        // Reads the Map Matrix and colors the tiles accordingly
        for (var i = 0; i < 10; i++)
        {
            for (var j = 0; j < 10; j++)
            {
                var fillType = mapMatrix[i][j].type;
                var xOffset = screenX + (100 * j);
                var yOffset = screenY + (100 * i);

                switch (fillType)
                {
                    case 1:
                        ctx.drawImage(Img.foodTile1, xOffset, yOffset);
                        break;

                    case 2:
                        ctx.drawImage(Img.stoneTile1, xOffset, yOffset);
                        break;

                    case 3:
                        ctx.drawImage(Img.forestTile1, xOffset, yOffset);
                        break;

                    case 4:
                        ctx.drawImage(Img.goldTile1, xOffset, yOffset);
                        break;

                    default:
                        ctx.fillStyle = 'white';
                        ctx.fillRect(xOffset, yOffset, 100, 100);
                }
            }
        }
        // TODO Function to check where the mouse is (highlight tile)

        // Set and draw units
        if (unitList)
        {
            for (var i = 0; i < unitList.length; i++)
            {
                var unit = unitList[i];
                ctx.drawImage(Img.unit, screenX + unit.x, screenY + unit.y);
            }
        }

        ctx.fillStyle = "black";

        if (mouseDown) // Draw the highlight if clicking
        {
            var width = mouseX - mouseClickPos.x;
            var height = mouseY - mouseClickPos.y;

            ctx.fillStyle = 'red';
            ctx.globalAlpha = 0.2;
            ctx.fillRect(mouseClickPos.x - clickOffsetX,
                mouseClickPos.y - clickOffsetY, width + clickOffsetX,
                height + clickOffsetY);
            ctx.globalAlpha = 1;
        }

        drawMiniMap();

        // Draw mouse cursor
        ctx.drawImage(Img.cursor, mouseX, mouseY);

        drawScore();
    }, 40);

    // Draw the bar at the top of page with information (will eventually be score + resource count)
    var drawScore = function ()
    {
        ctx.fillStyle = 'black';
        ctx.globalAlpha = 0.5;
        ctx.fillRect(0, 0, WIDTH, 40);
        ctx.globalAlpha = 1;
        ctx.fillStyle = 'white';
        ctx.font = "30px Verdana";
        ctx.fillText("X: " + mouseX + " Y: "
            + mouseY + " clickOffsetX: " + clickOffsetX
            + " clickOffsetY: " + clickOffsetY
            + " click: " + mouseDown, WIDTH / 2 - 400, 30);
    }

</script>
</body>
</html>
